---
toc: true
title:  "[Spring] H2, Mockito ì•ˆì“°ê³  í…ŒìŠ¤íŠ¸ í•˜ê¸° (3) - Spring Data JPA"
last_modified_at:   2024-07-15
categories : Study
excerpt: "ì •í•©ì„±ì´ ê¹¨ì§€ì§€ ì•ŠëŠ” í…ŒìŠ¤íŠ¸ìš© JpaRepository êµ¬í˜„í•˜ê¸°"
image: ""
sitemap :
  changefreq : weekly
  priority : 1.0
use_math: true
published: true
---

[2í¸](https://yooniversal.github.io/study/post292/)ì—ì„œëŠ” JpaRepositoryë¥¼ êµ¬í˜„í•œ í…ŒìŠ¤íŠ¸ìš© Repositoryë¥¼ ì†Œê°œí–ˆë‹¤.<br>
ê·¸ì¹˜ë§Œ TestRepositoryë³„ë¡œ ì—”í‹°í‹° 1ê°œì˜ DBë§Œ ì§€ì›í•œë‹¤.<br>

ë•Œë¬¸ì— join ì¿¼ë¦¬ê°€ ìˆëŠ” Repositoryë¼ë©´ í•„ìš”í•œ ì—”í‹°í‹°ë“¤ì— ëŒ€í•œ TestRepositoryë¥¼ í•„ë“œë¡œ ì„ ì–¸í•´ì•¼ë§Œ í–ˆë‹¤.<br>

## ì •í•©ì„±ì´ ê¹¨ì§€ëŠ” ë¬¸ì œ
ê·¸ì¹˜ë§Œ í•´ë‹¹ ë°©ì‹ì€ ê°™ì€ ì—”í‹°í‹° ëŒ€ìƒì˜ Repositoryì„ì—ë„ ì •í•©ì„±ì´ ê¹¨ì§€ëŠ” ë¬¸ì œê°€ ë°œìƒí•œë‹¤.<br>
ì´í•´ë¥¼ ë•ê¸°ìœ„í•´ ê·¸ë¦¼ê³¼ í•¨ê»˜ ìì„¸íˆ ì„¤ëª…í•´ë³´ë©´,<br>

ì•„ë˜ëŠ” ìš´ì˜í™˜ê²½ì—ì„œ ì—¬ëŸ¬ Repositoryê°€ ê°™ì€ DBì— ì ‘ê·¼í•˜ëŠ” ëª¨ìŠµì´ë‹¤.<br>
ì‹¤ì œë¡œ DB ì•ˆì—ëŠ” ì—¬ëŸ¬ í…Œì´ë¸”ë¡œ êµ¬ì„±ë¼ìˆê¸° ë•Œë¬¸ì—, ê° RepositoryëŠ” í•„ìš”í•œ í…Œì´ë¸”ì— ì ‘ê·¼í•´ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê²Œ ëœë‹¤.<br>
<div style="text-align: center;">
<img src="https://lh3.google.com/u/0/d/1ep4-xYEc1uXVF3HagG4V0aa_iTBAsIGL" width="60%" height="60%" title="$0715_real_status.png" alt="?"/>
</div>
<br>

ê·¸ëŸ°ë° TestRepositoryëŠ” ë‹¤ë¥´ë‹¤. ë‹¤ë¥¸ ì—”í‹°í‹°ë“¤ì—ë„ ì ‘ê·¼ì´ í•„ìš”í•´ ì—¬ëŸ¬ TestRepositoryë¥¼ í•„ë“œë¡œ ì„ ì–¸í–ˆì§€ë§Œ <br>
ëª¨ë‘ ê°ì ì—”í‹°í‹°ì—ë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” DBë¥¼ í’ˆê³  ìˆëŠ” ëª¨ìŠµì´ë‹¤. ì—¬ê¸°ê¹Œì§€ëŠ” ì„¤ëª…í–ˆë˜ ë‚´ìš©ì´ë‹¤.<br>
<div style="text-align: center;">
<img src="https://lh3.google.com/u/0/d/1QXb2Mnew5VYI1d7s0xKXvOt6_u8awCoK" width="45%" height="45%" title="$0715_sub_repository.png" alt="?"/>
</div>
<br>

Repositoryê°€ `ARepository`, `BRepository`ë¥¼ í•„ë“œë¡œ ê°–ê³  ìˆê³ , `ARepository`ê°€ ë‹¨ë…ìœ¼ë¡œ ì“°ì´ëŠ” ê²½ìš°ë„ ìˆë‹¤ê³  í•´ë³´ì.<br>
(ëª¨ë‘ ë‹¤ TestJpaRepositoryë¥¼ ìƒì†ë°›ì€ í…ŒìŠ¤íŠ¸ìš© repositoryë¼ ê°€ì •í•œë‹¤.)<br>

Parentì— ì†í•˜ëŠ” Aì˜ valueë¥¼ 1 ì¦ê°€ì‹œì¼œì„œ, ARepositoryì—ì„œ êº¼ë‚¸ Aì˜ valueì™€ ê°™ì€ì§€ í™•ì¸í•˜ëŠ” í…ŒìŠ¤íŠ¸ë‹¤.<br>
```kotlin
class DatabaseTest {
    private val repository = Repository<Parent, Long>()
    private val aRepository = ARepository<A, Long>()

    @Test
    fun `ë‹¤ë¥¸ Repositoryë¼ë©´ ë°ì´í„° ì •í•©ì„±ì´ ê¹¨ì§„ë‹¤`() {
        // given
        val aEntity = aRepository.save(A(value = 1))
        val bEntity = B()
        val parentEntity = Parent(a = aEntity, b = bEntity)
        repository.save(parentEntity)
        
        // when
        val parent = repository.findById(1L)
        parent.a.value = parent.a.value + 1 // Parentì˜ A.valueë¥¼ 1 ì¦ê°€
        repository.save(parent) // ê¸°ì¡´ A ì—”í‹°í‹°ì— ëŒ€í•´ ì—…ë°ì´íŠ¸

        // then
        val target = repository.findById(1L).a
        val savedAEntity = aRepository.findById(1L)
        assertThat(target.value).isNotEqualTo(savedAEntity.value) // true
    }
}
```
- `target.value`ì™€ `savedAEntity.value`ëŠ” **ê°’ì´ ì¼ì¹˜í•˜ì§€ ì•Šì•„ í…ŒìŠ¤íŠ¸ì— ì„±ê³µ**
  + `target.value` : **2**
  + `savedAEntity.value` : 1
<br>

ì™œ ì´ëŸ° í˜„ìƒì´ ë°œìƒí• ê¹Œ?<br>
Repositoryì—ì„œ í•„ë“œë¡œ ê°–ëŠ” ARepositoryë¥¼ **ìƒˆ ì¸ìŠ¤í„´ìŠ¤**ë¡œ ì´ˆê¸°í™”í•´ì£¼ê¸° ë•Œë¬¸ì´ë‹¤.<br>
```kotlin
class TestBeverageRepository : JpaRepository<Beverage, Long> {
    private val aRepository: TestARepository<A, Long>()
}
```
<br>

ê·¸ë˜ì„œ ê°™ì€ DBë¼ê³  ìƒê°í–ˆì§€ë§Œ **ì„œë¡œ ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ìƒì„±ëœ DB**(entityList)ì—¬ì„œ ì •í•©ì„±ì´ ê¹¨ì§€ëŠ” ê²ƒì´ë‹¤.<br>
<div style="text-align: center;">
<img src="https://lh3.google.com/u/0/d/14DLMltrJ_JD1A1mjgId6HYt0rUlQYL__" width="60%" height="60%" title="$0715_different_db.png" alt="?"/>
</div>
<br>

## ê°œì„ ëœ TestJpaRepository
ê·¸ëŸ¬ë©´ ì´ ê²½ìš°ëŠ” ì–´ë–»ê²Œ ê·¹ë³µí•´ì•¼ í• ê¹Œ?<br>
TestRepositoryì—ì„œ ì‚¬ìš©í•  DBë¥¼ **í•œë²ˆì— ìƒì„±í•´ ê´€ë¦¬í•˜ë©´ ëœë‹¤!**<br>

TestJpaRepositoryì—ì„œ ì‚¬ìš©í•˜ë˜ í•„ë“œ ì •ë³´ë“¤ì„ **TestDatabase** í´ë˜ìŠ¤ì—ì„œ ê´€ë¦¬í•œë‹¤.<br>
ê·¸ë¦¬ê³  ì—”í‹°í‹°ë³„ë¡œ ì„ ì–¸í•´ì£¼ì.<br>
```kotlin
class TestDatabase<T, ID>(
    val idName: String,
) {
    val index = AtomicLong(0L)
    val indexSet = mutableSetOf<ID>()
    val entityList = mutableListOf<T>()
}

// ì—”í‹°í‹°ë³„ë¡œ DB ì„ ì–¸
val PARENT_TEST_DB = TestDatabase<Parent, Long>("id")
val A_TEST_DB = TestDatabase<A, Long>("id")
val B_TEST_DB = TestDatabase<B, Long>("id")
```
<br>

TestJpaRepositoryëŠ” TestDatabaseë¥¼ ìƒì„±ì íŒŒë¼ë¯¸í„°ë¡œ ë°›ê³ , ê¸°ì¡´ ë¡œì§ì—ì„œ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œë” ì´ˆê¸°í™”í•´ì¤€ë‹¤.<br>
```kotlin
abstract class TestJpaRepository<T, ID>(
    private val testDatabase: TestDatabase<T, ID>,
) : JpaRepository<T, ID> where T : Any {

    private val index: AtomicLong = testDatabase.index
    private val indexSet = testDatabase.indexSet
    private val idName = testDatabase.idName
    protected val entityList: MutableList<T> = testDatabase.entityList

    // ì•„ë˜ ë¡œì§ ë³€ê²½ì—†ìŒ
}
```
<br>

TestRepositoryë¥¼ ì •ì˜í•  ë•ŒëŠ” TestDatabaseë¥¼ ìƒì„±ìì—ì„œ ë°›ìœ¼ë©´ ëœë‹¤.<br>
ì—°ê´€ëœ Repositoryë„ ì´ˆê¸°í™”í•´ì£¼ëŠ” ì  ìŠì§€ ë§ì!<br>
```kotlin
class TestParentRepository : TestJpaRepository<Parent, Long>(PARENT_TEST_DB) {
    private val aRepository: TestARepository()
    private val bRepository: TestBRepository()
}

class TestARepository : TestJpaRepository<A, Long>(A_TEST_DB)
class TestBRepository : TestJpaRepository<B, Long>(B_TEST_DB)
```
<br>

ê·¸ëŸ¬ë©´ ë‹¤ë¥¸ ìœ„ì¹˜ì— ìˆëŠ” Repositoryì—¬ë„ ê°™ì€ TestDatabaseë¡œ ì´ˆê¸°í™”í•˜ê¸° ë•Œë¬¸ì— <br>
ë” ì´ìƒ ë°ì´í„° ì •í•©ì„±ì´ ê¹¨ì§€ëŠ” í˜„ìƒì´ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤!<br>
<div style="text-align: center;">
<img src="https://lh3.google.com/u/0/d/1XMWdwh7HBeNSWTmvjtb1Z6mLP_ZuXyLY" width="55%" height="55%" title="$0715_initilaized_db.png" alt="?"/>
</div>

DBë¥¼ ì¼ì¹˜ì‹œì¼œì£¼ëŠ” ê²ƒ ì™¸ì—ë„ JpaRepositoryì—ì„œ ì œê³µí•˜ëŠ” í•¨ìˆ˜ë„ ê°™ì´ ìˆ˜ì •í•´ì¤˜ì•¼í•œë‹¤.<br>
```kotlin
fun save(parent: Parent): Parent {
    return super.save(parent).also { parent -> 
        aRepository.save(parent.a)
        bRepository.save(parent.b)
    }
}

fun findById(id: Long): Parent {
    return super.findById(id).let { parent ->
        parent.a = aRepository.findById(parent.a.id)
        parent.b = bRepository.findById(parent.b.id)
    }
}
...
```
<br>

### ë‹¨ì 
[2í¸](https://yooniversal.github.io/study/post292/)ì˜ TestJpaRepositoryë³´ë‹¤ ì •í•©ì„±ì„ ê¹¨ëœ¨ë¦¬ì§€ ì•Šê¸°ìœ„í•´ ì¶”ê°€í•´ì¤˜ì•¼ í•˜ëŠ” ì½”ë“œê°€ ëŠ˜ì—ˆë‹¤.<br>
ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ì‚¬ìš©í•˜ëŠ” ì—”í‹°í‹°ê°€ ë§ì„ í…ë°, ì´ì— ë¹„ë¡€í•´ì„œ ì¶”ê°€í•  TestDatabase ì¸ìŠ¤í„´ìŠ¤ë„ ë§ì•„ì§ˆ ê²ƒì´ë‹¤.<br>
ì¼ë¶€ TestRepositoryì—ì„œëŠ” JpaRepositoryì—ì„œ ì œê³µí•˜ëŠ” í•¨ìˆ˜ë„ ì‚¬ì‹¤ìƒ ì¬êµ¬í˜„ì„ í•´ì•¼í•˜ê¸° ë•Œë¬¸ì— ë¶€ë‹´ì´ í¬ë‹¤.<br>

í…ŒìŠ¤íŠ¸ì—ì„œ ì •í•©ì„±ì´ ê¹¨ì§ˆ ìˆ˜ ìˆëŠ” ìƒí™©ì´ê±°ë‚˜ ê·¸ë ‡ê²Œ ë  ìˆ˜ ìˆë‹¤ë©´ ì ìš©í•  í•„ìš”ê°€ ìˆê² ì§€ë§Œ, <br>
ê·¸ë ‡ì§€ ì•Šë‹¤ë©´ 2í¸ì˜ TestJpaRepositoryë¥¼ ì“°ëŠ”ê²Œ ì¢‹ì„ ê²ƒ ê°™ë‹¤.<br>

ëŒ€ë¶€ë¶„ í…ŒìŠ¤íŠ¸ê°€ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ì¼ê±° ê°™ì€ë°, ê·¸ëŸ° ê²½ìš°ì—ëŠ” ì‚¬ì‹¤ í•„ìš”ì—†ì„ ê²ƒ ê°™ë‹¤ğŸ¤”<br>

## References
- [Java/Spring í…ŒìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•˜ê³  ì‹¶ì€ ê°œë°œìë“¤ì˜ ì˜¤ë‹µë…¸íŠ¸](https://www.inflearn.com/course/ìë°”-ìŠ¤í”„ë§-í…ŒìŠ¤íŠ¸-ê°œë°œì-ì˜¤ë‹µë…¸íŠ¸)