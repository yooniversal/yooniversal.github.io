---
toc: true
title:  "[Spring] H2, Mockito ì•ˆì“°ê³  í…ŒìŠ¤íŠ¸ í•˜ê¸° (2) - Spring Data JPA"
last_modified_at:   2024-07-10
categories : Study
excerpt: "í…ŒìŠ¤íŠ¸ìš© JpaRepository ë§Œë“¤ê¸°"
image: ""
sitemap :
  changefreq : weekly
  priority : 1.0
use_math: true
published: true
---

[1í¸](https://yooniversal.github.io/study/post291/)ì—ì„œëŠ” í…ŒìŠ¤íŠ¸ìš© Repositoryë¥¼ ë§Œë“¤ì–´ì„œ ì§ì ‘ ì‚¬ìš©í–ˆì—ˆë‹¤!<br>
ê·¸ëŸ°ë° Spring Data JPAë¥¼ ì‚¬ìš©ì¤‘ì´ë¼ë©´ ì•„ë§ˆ Repository interfaceì— JpaRepositoryë¥¼ ìƒì†í•´ì„œ ì“¸ í™•ë¥ ì´ ë†’ë‹¤.<br>
```kotlin
interface BeverageRepository : JpaRepository<Beverage, Long> {
}

// Querydslì„ ì‚¬ìš©ì¤‘ì´ë¼ë©´
interface BeverageRepository : JpaRepository<Beverage, Long>, BeverageRepositoryCustom {
}
```
<br>

## ë¬¸ì œ ìƒí™©
### ì˜¤ë²„ë¼ì´ë”©í•  í•¨ìˆ˜ê°€ ë§ë‹¤
ì´ ê²½ìš°ì—ëŠ” BeverageRepositoryë¥¼ êµ¬í˜„í•˜ëŠ” í…ŒìŠ¤íŠ¸ìš© êµ¬ì²´ í´ë˜ìŠ¤ë¥¼ ì‘ì„±í•  ë•Œ JpaRepositoryì—ì„œ ì œê³µí•˜ëŠ” ëª¨ë“  í•¨ìˆ˜ë¥¼ <br>
ì˜¤ë²„ë¼ì´ë”©í•´ì¤˜ì•¼ í•˜ëŠ” ë²ˆê±°ë¡œì›€ì´ ìˆë‹¤. ê·¸ì¹˜ë§Œ ìš´ì˜ í™˜ê²½ì—ì„œ ì‚¬ìš©í•˜ëŠ” í•¨ìˆ˜ë§Œ êµ¬í˜„í•´ì£¼ë©´ ë˜ê¸° ë•Œë¬¸ì— í° ë¬¸ì œëŠ” ì•„ë‹ ìˆ˜ ìˆë‹¤.<br>

### ì¤‘ë³µ ë¡œì§ì´ ë§ì•„ì§„ë‹¤
ê·¸ì¹˜ë§Œ ë„ë©”ì¸ì´ Beverage ë¿ë§Œ ì•„ë‹ˆë¼ ì—¬ëŸ¬ê°€ì§€ê°€ ìˆë‹¤ê³  í•´ë³´ì.<br>
ì•„ë¬´ë¦¬ Spring Data JPAì—ì„œ ì œê³µí•˜ëŠ” í•¨ìˆ˜ë¥¼ ì ê²Œ ì“°ë”ë¼ë„, `save()`, `findById()` ë“±ì€ ì“¸ ê²ƒì´ë‹¤. ê·¸ëŸ¬ë©´ ì´ í•¨ìˆ˜ë“¤ì€ ëª¨ë“  í…ŒìŠ¤íŠ¸ìš© Repository í´ë˜ìŠ¤ì—ì„œ **ê°™ì€ ë¡œì§ì´ì§€ë§Œ ë˜‘ê°™ì´ êµ¬í˜„í•´ì¤˜ì•¼ í•œë‹¤.** ì‹¬ì§€ì–´ëŠ” ID, List ë“±ì˜ í•„ë“œë„ ê·¸ë ‡ë‹¤!<br>
```kotlin
class TestBeverageRepository : BeverageRepository {

    // í•„ë“œ ì¤‘ë³µ
    private val autoGeneratedId = AtomicLong(0)
    private val beverages = ArrayList<Beverage>()
    
    // ì €ì¥ í•¨ìˆ˜ ì¤‘ë³µ
    override fun save(beverage: Beverage): Beverage {
        return Beverage(
            id = autoGeneratedId.incrementAndGet(),
            name = beverage.name,
        ).also { beverages.add(it) }
    }
}

class TestBrandRepository : BrandRepository {

    // í•„ë“œ ì¤‘ë³µ
    private val autoGeneratedId = AtomicLong(0)
    private val brands = ArrayList<Brand>()
    
    // ì €ì¥ í•¨ìˆ˜ ì¤‘ë³µ
    override fun save(brand: Brand): Brand {
        return Brand(
            id = autoGeneratedId.incrementAndGet(),
            name = brand.name,
        ).also { brands.add(it) }
    }
}
```
<br>

## ê°œì„ ì•ˆ : JpaRepository í‰ë‚´ë‚´ê¸°
JpaRepositoryëŠ” ìì£¼ ì‚¬ìš©ë˜ëŠ” ë¡œì§ë“¤ì„ ê°€ì ¸ë‹¤ ë°”ë¡œ ì“¸ ìˆ˜ ìˆë„ë¡ ì˜ êµ¬í˜„ì´ ë¼ìˆë‹¤. í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œë„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤ë©´ ì¢‹ê² ì§€ë§Œ, 
entityManagerë¥¼ ì°¸ì¡°í•˜ê³  ìˆì–´ì„œ ì§€ê¸ˆì²˜ëŸ¼ DBì— ì˜ì¡´í•˜ì§€ ì•Šìœ¼ë ¤ëŠ” ìƒí™©ì—ì„œëŠ” ì ìš©í•˜ê¸° ì–´ë µë‹¤.<br>

ê·¸ëŸ¬ë©´ DBë¥¼ ì‚¬ìš©í•˜ì§€ëŠ” ì•Šì§€ë§Œ JpaRepositoryì—ì„œ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ë“¤ì€ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œë” í…ŒìŠ¤íŠ¸ ì „ìš©ìœ¼ë¡œ êµ¬í˜„í•˜ë©´ ë˜ì§€ ì•Šì„ê¹Œ?<br>

### ê´€ê³„ë„
êµ¬í˜„í•  ì¶”ìƒ í´ë˜ìŠ¤ë¥¼ **TestJpaRepository**ë¼ í•˜ë©´, ê´€ê³„ë„ëŠ” ì•„ë˜ì²˜ëŸ¼ ëœë‹¤.<br>
Querydslì„ ì‚¬ìš©í•œë‹¤ê³  í–ˆì„ ë•Œ, `BeverageRepositoryCustom`ì€ Querydslì„ ìœ„í•´ ë§Œë“¤ì–´ì§„ interfaceê³ <br>
ê·¸ê±¸ êµ¬í˜„í•œ í´ë˜ìŠ¤ë¥¼ `BeverageRepositoryImpl`ë¼ í•˜ì.<br>

<img src="https://lh3.google.com/u/0/d/16abHR1BRZUBqxhqBDgMEasYdQ5hacWRR" width="70%" height="70%" title="$0710-test-repository-1.png" alt="?"/>

- `TestJpaRepository`ëŠ” JpaRepositoryë¥¼ êµ¬í˜„
<br>
<br>

ì´ë•Œ í…ŒìŠ¤íŠ¸ì—ì„œ ì£¼ì…í•  TestBeverageRepositoryëŠ” `TestJpaRepository`ì™€ `BeverageRepository`ë¥¼ êµ¬í˜„í•œë‹¤.<br>
(BeverageRepositoryê°€ JpaRepositoryë¥¼ ì´ë¯¸ ìƒì†í•˜ê³  ìˆëŠ”ë° ë¬¸ì œì—†ëƒê³  í•  ìˆ˜ ìˆì§€ë§Œ, í…ŒìŠ¤íŠ¸í•  ë• ë¬¸ì œì—†ì—ˆë‹¤)<br>

<img src="https://lh3.google.com/u/0/d/1jP80yYF2VlPn5lNpxtFF8-KoMW5ek3kO" width="70%" height="70%" title="$0710-test-repository-2.png" alt="?"/>

ê·¸ëŸ¬ë©´ BeverageService í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ì—ì„œ BeverageRepository êµ¬í˜„ì²´ë¡œ **TestBeverageRepository**ë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤ğŸ˜<br>

### TestJpaRepository êµ¬í˜„
TestJpaRepositoryë¥¼ êµ¬í˜„í•  ë• 2ê°€ì§€ë¥¼ ê³ ë ¤í–ˆë‹¤.<br>
1. ìœ„ ë¡œì§ì²˜ëŸ¼ DB ì—­í• ì„ í•´ì¤„ ID, List **í•„ë“œ**ëŠ” ê·¸ëŒ€ë¡œ ê°€ì ¸ê°„ë‹¤.
2. ì—¬ëŸ¬ íƒ€ì…ì„ ë°›ì„ ìˆ˜ ìˆë„ë¡ **ì œë„¤ë¦­**ìœ¼ë¡œ êµ¬í˜„í•œë‹¤. (ì—”í‹°í‹°, ID íƒ€ì…)

`T, ID`ëŠ” JpaRepositoryì²˜ëŸ¼ ì—”í‹°í‹°ì™€ IDë¥¼ ì œë„¤ë¦­ìœ¼ë¡œ ë°›ëŠ”ë‹¤.<br>
(ë‹¨, ì—”í‹°í‹° íƒ€ì…ì€ nullì´ë©´ ì•ˆë˜ë¯€ë¡œ whereì— `T : Any`ë¡œ ì¡°ê±´ì„ ê±¸ì—ˆë‹¤.)<br>

idNameì„ ì…ë ¥ë°›ì•„ í•„ë“œë¡œ ê´€ë¦¬í•˜ëŠ”ë°, ì—”í‹°í‹° id í•„ë“œ ì´ë¦„ì€ ë‹¤ì–‘í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì…ë ¥ë°›ë„ë¡ í–ˆë‹¤.<br>
ì¢€ ë” ì•„ë˜ì—ì„œ idë¥¼ ì¶”ì¶œí•˜ëŠ” `getId()`ë‚˜ id ê°’ì„ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” `updateId()`ì—ì„œ ë¦¬í”Œë ‰ì…˜í•  ë•Œ ì‚¬ìš©ëœë‹¤.<br>

ê·¸ë¦¬ê³  ìœ„ì— TestBeverageRepository ì½”ë“œì— ìˆë˜ í•„ë“œë“¤ì„ ì—¬ê¸°ì—ì„œ index, entityListë¡œ ì •ì˜í•œë‹¤.<br>
ì´ë ‡ê²Œ ë˜ë©´ TestJpaRepositoryë¥¼ ìƒì†í•˜ëŠ” ê²ƒë§Œìœ¼ë¡œ ì´ëŸ° í•„ë“œë“¤ì„ êµ³ì´ ë°˜ë³µí•´ì„œ ì •ì˜í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.<br>
```kotlin
abstract class TestJpaRepository<T, ID>(
    private val idName: String,
) : JpaRepository<T, ID> where T : Any {

    private val index = AtomicLong(0L) // ìœ„ì—ì„œ autoGeneratedIdì™€ ê°™ì€ ì—­í• 
    private val indexSet = mutableSetOf<ID>()
    protected val entityList = mutableListOf<T>() // ìœ„ì—ì„œ beveragesì™€ ê°™ì€ ì—­í• 
    ...
}
```
- `indexSet` : ì„±ëŠ¥ í–¥ìƒì„ ìœ„í•´ ì‚¬ìš© (optional)

ì´ê±¸ ìƒì†ë°›ì€ í´ë˜ìŠ¤ë¥¼ ì •ì˜í•  ë•ŒëŠ” ì•„ë˜ì²˜ëŸ¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤.<br>
```kotlin
// Beverageì˜ ID í•„ë“œ ì´ë¦„ì´ `id`ë¼ ê°€ì •
class TestBeverageRepository : TestJpaRepository<Beverage, Long>("id")

// ë§Œì•½ Querydslì„ ì‚¬ìš©í•´ BeverageRepositoryCustom interfaceê°€ ìˆë‹¤ë©´ ì•„ë˜ì²˜ëŸ¼ ì“°ë©´ ë¨
class TestBeverageRepository : TestJpaRepository<Beverage, Long>("id"), BeverageRepositoryCustom
```
<br>

í•¨ìˆ˜ëŠ” JpaRepositoryì—ì„œ ì œê³µí•˜ëŠ” `save()`, `findById()`, `existsById()` ë“±ì„ êµ¬í˜„í•œë‹¤.<br>
entityListì— ì €ì¥í•˜ê±°ë‚˜ ì¡°íšŒí•˜ëŠ” ë“±ì˜ ë¡œì§ë§Œ ë„£ì–´ì£¼ë©´ ë˜ì„œ ì–´ë µì§€ ì•Šë‹¤.<br>
```kotlin
override fun <S : T> save(entity: S): S {
    Assert.notNull(entity, ENTITY_MUST_NOT_BE_NULL)
    upsert(entity) // ì•„ë˜ì—ì„œ ì„¤ëª…
    return entity
}

override fun findById(id: ID): Optional<T> {
    Assert.notNull(id, ID_MUST_NOT_BE_NULL)
    return Optional.ofNullable(entityList.find { it.getId<T, ID>() == id })
}

override fun existsById(id: ID): Boolean {
    Assert.notNull(id, ID_MUST_NOT_BE_NULL)
    return entityList.any { it.getId<T, ID>() == id }
}
```
- `Assert.notNull()` : ì œë„¤ë¦­ìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” íŒŒë¼ë¯¸í„°ê°€ nullì¸ì§€ ê²€ì¦
- idë¡œ ë¹„êµê°€ í•„ìš”í•œ ê²½ìš° entityListì˜ ìš”ì†Œì¸ entityì˜ id ê°’ì€ `getId<T, ID>()`ë¥¼ ì‚¬ìš©
  + entity íƒ€ì…ì´ ì œë„¤ë¦­(`S`)ìœ¼ë¡œ ë“¤ì–´ì™”ê¸° ë•Œë¬¸ì— ë‚´ë¬´ í•„ë“œì¸ idë¥¼ ì§ì ‘ ì°¸ì¡°í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ë¦¬í”Œë ‰ì…˜ í™œìš©
- `flush()` ê°™ì€ í•¨ìˆ˜ëŠ” ì—¬ê¸°ì„œ í•„ìš”ì—†ìœ¼ë¯€ë¡œ bodyë¥¼ ë¹„ì›Œë†“ìŒ

`save()` ì•ˆì— `upsert()`ëŠ” update or insertë¥¼ í•˜ëŠ” í•¨ìˆ˜ë‹¤.<br>
`isNew()`ë¡œ ê²€ì¦í•´ Long, Int, Stringì´ ê¸°ë³¸ê°’ì´ë©´ update, ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ insertë¥¼ ìˆ˜í–‰í•œë‹¤.<br>
updateí•˜ëŠ” ê²½ìš° ê¸°ì¡´ entityê°€ entityListì—ì„œ ì‚­ì œë¼ì•¼ í•˜ë¯€ë¡œ ì§€ìš°ê³  ìƒˆë¡œ ë§Œë“  entityë¥¼ ì‚½ì…í•œë‹¤.<br>
```kotlin
private fun <S : T> upsert(entity: S) {
    val requestId = entity.getId<T, ID>()
    if (isNew(requestId)) {
        updateId(entity)
    } else {
        entityList.removeIf { it.getId<T, ID>() == requestId }
    }
    entityList.add(entity)
}

private fun isNew(id: Any?): Boolean {
    if (id == null) return true
    return when (id) {
        is Long -> id == 0L
        is Int -> id == 0
        is String -> id.isEmpty()
        else -> throw IllegalArgumentException("Unsupported id type: ${id::class.simpleName}")
    }
}

private fun <S : T> updateId(entity: S) {
    entity::class.java.getDeclaredField(idName).apply {
        isAccessible = true

        generateId(type).let { newIndex ->
            set(entity, newIndex)
            if (indexSet.contains(newIndex)) {
                entityList.removeIf { it.getId<T, ID>() == newIndex }
            } else {
                indexSet.add(newIndex)
            }
        }
    }
}
```
- `updateId()` : entityì˜ idë¥¼ ì§ì ‘ ì°¸ì¡°í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— ë¦¬í”Œë ‰ì…˜ìœ¼ë¡œ ê°’ì„ ì¡°ì‘í•´ ìƒˆ id ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í•¨
- `generateId()` : AtomicLong.incrementAndGet()ì´ë‚˜ UUID.randomUUID()ë¡œ ìƒˆ id ê°’ ìƒì„±

`getId()`ëŠ” T íƒ€ì…ì¸ entityì˜ id ê°’ì„ ë¦¬í”Œë ‰ì…˜ìœ¼ë¡œ ì–»ì–´ë‚´ëŠ” í•¨ìˆ˜ë‹¤.<br>
í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ì—ì„œ ì‚¬ìš©í•  ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ ì ‘ê·¼ ì œí•œìëŠ” `protected`ë¡œ ì„¤ì •í–ˆë‹¤.<br>
```kotlin
protected fun <T : Any, ID> T.getId(): ID? {
    return this::class.memberProperties
        .firstOrNull { it.name == idName }?.getter?.call(this) as? ID
}
```
- `this::class` : T(this)ì˜ KClass
- Tì˜ ëª¨ë“  í•„ë“œë¥¼ ëŒë©´ì„œ ìœ„ì—ì„œ ì…ë ¥í•œ **idNameê³¼ ê°™ì€ í•„ë“œë¥¼ ì°¾ì•„** ê°’ì„ ë°˜í™˜

## JpaRepositoryì—ë§Œ ì œí•œë˜ëŠ” ë°©ì‹ì´ ì•„ë‹ˆë‹¤
`TestJpaRepository`ëŠ” JpaRepositoryë¥¼ ìƒì†ë°›ì•„ êµ¬í˜„í•œ ì¶”ìƒ í´ë˜ìŠ¤ë‹¤. <br>
ê·¸ë˜ì„œ ì½”ë“œìƒìœ¼ë¡œëŠ” JpaRepositoryì— ì˜ì¡´í•˜ëŠ” í´ë˜ìŠ¤ë¼ê³  ë³¼ ìˆ˜ ìˆë‹¤. <br>

ê·¸ì¹˜ë§Œ JpaRepositoryë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì½”ë“œë¼ê³  í•´ë„, `save()`, `findById()`, `findAll()`ì˜ ì—­í• ì€ í•˜ë©´ì„œ 
ì´ë¦„ë§Œ ë‹¤ë¥¸ í•¨ìˆ˜ë“¤ì´ ë†’ì€ í™•ë£°ë¡œ ìˆì„ ê²ƒì´ê³  ì‚¬ìš©ì¤‘ì¸ ë©”ì†Œë“œëª…ìœ¼ë¡œ ì¼ì¹˜ì‹œì¼œì¤€ë‹¤ë©´ ì–¼ë§ˆë“ ì§€ í™œìš©í•  ìˆ˜ ìˆë‹¤.<br>
JpaRepositoryë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” í™˜ê²½ì—ì„œë„ ë¬¸ì œì—†ì´ ë„ì…í•  ìˆ˜ ìˆì„ ê²ƒì´ë‹¤!<br>

## References
- [Java/Spring í…ŒìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•˜ê³  ì‹¶ì€ ê°œë°œìë“¤ì˜ ì˜¤ë‹µë…¸íŠ¸](https://www.inflearn.com/course/ìë°”-ìŠ¤í”„ë§-í…ŒìŠ¤íŠ¸-ê°œë°œì-ì˜¤ë‹µë…¸íŠ¸)